<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>سجلات {{ region }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body { background: #f8f9fa; padding: 20px; font-family: sans-serif; }
        .action-bar { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .delete-checkbox { display: none; width: 20px; height: 20px; }
        #qr-mini { position: fixed; bottom: 20px; left: 20px; cursor: pointer; background: white; padding: 10px; border-radius: 50%; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

    <div class="container">
        <div class="action-bar d-flex justify-content-between align-items-center flex-wrap gap-2">
            <h3>سجل منطقة: <span class="text-primary">{{ region }}</span></h3>
            <div class="d-flex gap-2">
                <button class="btn btn-warning btn-sm" onclick="toggleSelect()">
                    <i class="fas fa-check-square"></i> تحديد للحذف
                </button>
                <button id="deleteBtn" class="btn btn-danger btn-sm" style="display:none;" onclick="deleteSelected()">
                    تأكيد الحذف
                </button>
                <a href="{{ url_for('manage_cars', id=reg_id) }}" class="btn btn-info btn-sm text-white">تعديل أنواع السيارات</a>
                <a href="/" class="btn btn-secondary btn-sm">رجوع</a>
            </div>
        </div>

        <table class="table table-hover bg-white rounded shadow-sm">
            <thead class="table-dark">
                <tr>
                    <th class="select-col" style="display:none;">#</th>
                    <th>الاسم</th>
                    <th>الرقم العسكري</th>
                    <th>السيارة</th>
                    <th>رقم السيارة</th>
                    <th>الوقت</th>
                </tr>
            </thead>
            <tbody id="logsTable">
                {% for log in logs %}
                <tr id="row-{{ log.id }}">
                    <td class="select-col" style="display:none;">
                        <input type="checkbox" class="delete-checkbox" value="{{ log.id }}">
                    </td>
                    <td>{{ log.username }}</td>
                    <td>{{ log.military_id }}</td>
                    <td>{{ log.car_type }}</td>
                    <td><span class="badge bg-light text-dark border">{{ log.car_plate }}</span></td>
                    <td>{{ log.timestamp.strftime('%H:%M - %Y/%m/%d') }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div id="qr-mini" onclick="alert('سوي سكان للطباعة')">
        <div id="small_qr"></div>
    </div>

    <script>
        new QRCode(document.getElementById("small_qr"), { text: "{{ qr_link }}", width: 50, height: 50 });

        function toggleSelect() {
            const cols = document.querySelectorAll('.select-col');
            const checks = document.querySelectorAll('.delete-checkbox');
            const btn = document.getElementById('deleteBtn');
            cols.forEach(c => c.style.display = c.style.display === 'none' ? 'table-cell' : 'none');
            checks.forEach(c => c.style.display = c.style.display === 'none' ? 'block' : 'none');
            btn.style.display = btn.style.display === 'none' ? 'inline-block' : 'none';
        }

        function deleteSelected() {
            const selected = Array.from(document.querySelectorAll('.delete-checkbox:checked')).map(cb => cb.value);
            if (selected.length === 0) return alert('يرجى تحديد سجلات أولاً');
            if (confirm('هل أنت متأكد من حذف السجلات المختارة؟')) {
                fetch('/delete_logs', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ids: selected})
                }).then(() => location.reload());
            }
        }
    </script>
</body>
</html>